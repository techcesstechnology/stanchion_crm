rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Safely get user profile data
    function getUserProfile() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data;
    }

    // Helper to check user role with safe exists() check
    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) &&
             getUserProfile().role == role;
    }

    function isAdmin() { return hasRole('ADMIN'); }
    function isManager() { return hasRole('MANAGER'); }
    function isAccountant() { return hasRole('ACCOUNTANT'); }

    // Logic Helpers
    function isOwner(data) {
      return isAuthenticated() && data.submittedBy.uid == request.auth.uid;
    }

    function isValidTransition(oldStatus, newStatus) {
      return (oldStatus == 'DRAFT' && (newStatus == 'SUBMITTED' || newStatus == 'CANCELLED')) ||
             (oldStatus == 'SUBMITTED' && (newStatus == 'APPROVED_BY_ACCOUNTANT' || newStatus == 'REJECTED_BY_ACCOUNTANT')) ||
             (oldStatus == 'APPROVED_BY_ACCOUNTANT' && (newStatus == 'APPROVED_FINAL' || newStatus == 'REJECTED_BY_MANAGER'));
    }

    function coreFieldsUnchanged(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    match /contacts/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /leads/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /tasks/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /invoices/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /payments/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /quotes/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /settings/{document} {
      allow read, write: if isAuthenticated();
    }

    match /userProfiles/{userId} {
      allow read: if isAuthenticated();
      // Allow users to create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to update their own profile EXCEPT 'role', OR admins to update any field
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && coreFieldsUnchanged(['role'])) || 
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    match /activities/{document} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.createdBy.uid == request.auth.uid);
      allow delete: if isAuthenticated() && (resource.data.createdBy.uid == request.auth.uid || isAdmin());
    }

    match /catalogItems/{document} {
      allow read: if isAuthenticated();
      allow create, delete: if isAdmin();
      // Allow admins to update stock manually; prevent other users from touching stock
      allow update: if isAuthenticated() && (isAdmin() || coreFieldsUnchanged(['stock']));
    }

    match /accounts/{document} {
      allow read: if isAuthenticated();
      // Allow any authenticated user to update (balance updates happen during invoice payments)
      allow update: if isAuthenticated();
      allow create, delete: if isAdmin();
    }

    match /financeAccounts/{document} {
      allow read: if isAuthenticated();
      allow create, delete: if isAdmin();
      // Protect balance from direct client write
      allow update: if isAuthenticated() && (isAdmin() || coreFieldsUnchanged(['balance']));
    }

    match /financeTransactions/{document} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    (request.resource.data.status == 'DRAFT' || request.resource.data.status == 'SUBMITTED') &&
                    request.resource.data.submittedBy.uid == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (
          // Only allow requester to Submit or Cancel from the client
          (resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED' && isOwner(resource.data)) ||
          (resource.data.status != 'CANCELLED' && request.resource.data.status == 'CANCELLED' && isOwner(resource.data)) ||
          
          // Allow editing other fields in DRAFT
          (resource.data.status == 'DRAFT' && isOwner(resource.data) && request.resource.data.status == 'DRAFT')
        )
      ) && (
        // Protect status and approval fields EXCEPT during submission
        (resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED' || coreFieldsUnchanged(['approvalTrail', 'workflow'])) &&
        (resource.data.status == 'DRAFT' || isAdmin() || coreFieldsUnchanged(['amount', 'sourceAccountId', 'targetAccountId', 'type', 'status']))
      );
      
      allow delete: if isAdmin();
    }

    match /transactions/{document} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    (request.resource.data.status == 'DRAFT' || request.resource.data.status == 'SUBMITTED' || request.resource.data.status == 'APPROVED_FINAL') &&
                    request.resource.data.submittedBy.uid == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (
          // Only allow requester to Submit or Cancel from the client
          (resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED' && isOwner(resource.data)) ||
          (resource.data.status != 'CANCELLED' && request.resource.data.status == 'CANCELLED' && isOwner(resource.data)) ||
          
          // Allow editing other fields in DRAFT
          (resource.data.status == 'DRAFT' && isOwner(resource.data) && request.resource.data.status == 'DRAFT')
        )
      ) && (
        // Field Protection: Prevent client from touching approval fields or core fields after submission
        ((resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED') || coreFieldsUnchanged(['approvalTrail', 'workflow'])) &&
        (resource.data.status == 'DRAFT' || isAdmin() || coreFieldsUnchanged(['amount', 'accountId', 'type', 'category', 'status']))
      );
      
      allow delete: if isAdmin();
    }

    match /jobCards/{document} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    (request.resource.data.status == 'DRAFT' || request.resource.data.status == 'SUBMITTED') &&
                    request.resource.data.submittedBy.uid == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (
          // Only allow requester to Submit or Cancel from the client
          (resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED' && isOwner(resource.data)) ||
          (resource.data.status != 'CANCELLED' && request.resource.data.status == 'CANCELLED' && isOwner(resource.data)) ||
          
          // Allow editing other fields in DRAFT
          (resource.data.status == 'DRAFT' && isOwner(resource.data) && request.resource.data.status == 'DRAFT')
        )
      ) && (
        // Field Protection: Prevent client from touching approval fields or core fields after submission
        coreFieldsUnchanged(['issuedMovementId', 'returnedMovementIds']) &&
        ((resource.data.status == 'DRAFT' && request.resource.data.status == 'SUBMITTED') || coreFieldsUnchanged(['approvalTrail', 'workflow'])) &&
        (resource.data.status == 'DRAFT' || isAdmin() || coreFieldsUnchanged(['materials', 'totalCost', 'projectName', 'clientId', 'status']))
      );
      
      allow delete: if isAdmin();
    }

    match /inventoryItems/{document} {
      allow read: if isAuthenticated();
      allow create, delete: if isAdmin();
      // Enforce non-negative stock and protect SKU/Name from non-admins
      allow update: if isAuthenticated() && 
                    request.resource.data.onHandQty >= 0 &&
                    (isAdmin() || coreFieldsUnchanged(['sku', 'name', 'unit']));
    }

    match /inventoryMovements/{document} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                    request.resource.data.createdBy.uid == request.auth.uid;
      // Ledger entries are immutable once created
      allow update, delete: if false;
    }

    match /inquiries/{document} {
      allow read, write: if isAuthenticated();
    }

    match /notifications/{document} {
      allow read, write: if isAuthenticated();
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
